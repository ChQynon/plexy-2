// –≠—Ç–æ –±–∞–∑–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –≤–µ–±—Ö—É–∫–∞ –¥–ª—è Vercel
const { Telegraf } = require('telegraf');
const express = require('express');

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
const bot = new Telegraf(process.env.TELEGRAM_BOT_TOKEN);

// –°–æ–∑–¥–∞–Ω–∏–µ Express –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
const app = express();

// –ü—Ä–æ—Å—Ç–µ–π—à–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
const mainMenuKeyboard = {
  keyboard: [
    ['üå± –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–∞—Å—Ç–µ–Ω–∏–µ', 'üíä –í–∏—Ç–∞–º–∏–Ω—ã –∏ –ø–∏—Ç–∞–Ω–∏–µ'],
    ['üë®‚Äçüíª –°–æ–∑–¥–∞—Ç–µ–ª–∏', '‚ÑπÔ∏è –ü–æ–º–æ—â—å']
  ],
  resize_keyboard: true
};

// –ü—Ä–æ—Å—Ç–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start
bot.start((ctx) => {
  ctx.reply(
    '–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–∞—Å—Ç–µ–Ω–∏–π –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –Ω–∏—Ö. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ —Ä–∞—Å—Ç–µ–Ω–∏—è –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –æ–ø—Ü–∏—é –∏–∑ –º–µ–Ω—é.', 
    { reply_markup: mainMenuKeyboard }
  );
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ —Ä–∞—Å—Ç–µ–Ω–∏–π
bot.on('photo', async (ctx) => {
  await ctx.reply('–ü–æ–ª—É—á–∏–ª –≤–∞—à—É —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é! –≠—Ç–æ —Ä–∞–±–æ—Ç–∞—é—â–∞—è –≤–µ—Ä—Å–∏—è –±–æ—Ç–∞ –Ω–∞ Vercel.');
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–°–æ–∑–¥–∞—Ç–µ–ª–∏"
bot.hears('üë®‚Äçüíª –°–æ–∑–¥–∞—Ç–µ–ª–∏', async (ctx) => {
  await ctx.reply(
    '<b>–°–æ–∑–¥–∞—Ç–µ–ª–∏ –±–æ—Ç–∞:</b>\n\n' +
    '‚Ä¢ <b>@qynon</b> - <i>–ö–µ–Ω–∂–µ“ì–∞–ª–∏ –ù“±—Ä–∞—Å</i>\n' +
    '‚Ä¢ <b>@iapmon</b> - <i>–°–∞—Ä—Å–µ–Ω–±–∏“ì–∞–ª–∏“õ—ã–∑—ã –ó–µ—Ä–µ</i>\n\n' +
    '–°–ø–∞—Å–∏–±–æ –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∞—à–µ–≥–æ –±–æ—Ç–∞!',
    { parse_mode: 'HTML' }
  );
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ü–æ–º–æ—â—å"
bot.hears('‚ÑπÔ∏è –ü–æ–º–æ—â—å', async (ctx) => {
  await ctx.reply(
    '–Ø –ø–æ–º–æ–≥—É –≤–∞–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–∞—Å—Ç–µ–Ω–∏—è –∏ —É–∑–Ω–∞—Ç—å –æ –Ω–∏—Ö –±–æ–ª—å—à–µ.\n\n' +
    '–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ —Ä–∞—Å—Ç–µ–Ω–∏—è, –∏ —è —Ä–∞—Å—Å–∫–∞–∂—É, —á—Ç–æ —ç—Ç–æ –∑–∞ —Ä–∞—Å—Ç–µ–Ω–∏–µ.\n\n' +
    '–°–∫–æ—Ä–æ –ø–æ—è–≤—è—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏!'
  );
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–∞—Å—Ç–µ–Ω–∏–µ"
bot.hears('üå± –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–∞—Å—Ç–µ–Ω–∏–µ', async (ctx) => {
  await ctx.reply('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é —Ä–∞—Å—Ç–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä–æ–µ —Ö–æ—Ç–∏—Ç–µ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å.');
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–í–∏—Ç–∞–º–∏–Ω—ã –∏ –ø–∏—Ç–∞–Ω–∏–µ"
bot.hears('üíä –í–∏—Ç–∞–º–∏–Ω—ã –∏ –ø–∏—Ç–∞–Ω–∏–µ', async (ctx) => {
  await ctx.reply('–†–∞–∑–¥–µ–ª –æ –≤–∏—Ç–∞–º–∏–Ω–∞—Ö –∏ –ø–∏—Ç–∞–Ω–∏–∏ —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω!');
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
bot.on('text', async (ctx) => {
  const userMessage = ctx.message.text;
  
  // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –∫–Ω–æ–ø–∫–∞ –º–µ–Ω—é
  if (!['üå± –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–∞—Å—Ç–µ–Ω–∏–µ', 'üíä –í–∏—Ç–∞–º–∏–Ω—ã –∏ –ø–∏—Ç–∞–Ω–∏–µ', 'üë®‚Äçüíª –°–æ–∑–¥–∞—Ç–µ–ª–∏', '‚ÑπÔ∏è –ü–æ–º–æ—â—å'].includes(userMessage)) {
    await ctx.reply('–Ø –ø–æ–Ω–∏–º–∞—é –∫–æ–º–∞–Ω–¥—ã –º–µ–Ω—é –∏ –º–æ–≥—É –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Ä–∞—Å—Ç–µ–Ω–∏–π. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –º–µ–Ω—é –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ.', 
      { reply_markup: mainMenuKeyboard }
    );
  }
});

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Express –¥–ª—è –≤–µ–±—Ö—É–∫–∞ Telegram
app.use(express.json());
app.use(bot.webhookCallback('/api/webhook'));

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
app.get('/api/health', (req, res) => {
  res.status(200).send('OK');
});

// –ö–æ—Ä–Ω–µ–≤–æ–π –º–∞—Ä—à—Ä—É—Ç
app.get('/', (req, res) => {
  res.status(200).send('Telegram Bot is running');
});

// –≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è Vercel
module.exports = app; 